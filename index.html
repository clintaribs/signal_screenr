<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>TRUTHWATCH Audit</title>
    <style>
        :root {
            --bg: #0b1118; --surface: #161d27; --text: #e0e6ed;
            --primary: #3e92cc; --danger: #ff5f5f; --warn: #f4a261; --success: #4caf50;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; 
            margin: 0; overflow: hidden; height: 100vh;
        }

        #app { display: flex; height: 100vh; width: 100vw; }
        
        /* --- SIDEBAR (RANKINGS) --- */
        #sidebar { 
            width: 100%; border-right: 1px solid #232d3d; display: flex; flex-direction: column; background: var(--bg);
        }
        #rank-list { flex-grow: 1; overflow-y: auto; padding: 15px; }

        .channel-card {
            background: var(--surface); padding: 16px; border-radius: 12px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #232d3d; cursor: pointer;
        }
        .truth-score { font-size: 1.2rem; font-weight: 800; color: var(--primary); }

        /* --- AUDIT MODAL --- */
        #modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); transform: translateY(100%); transition: transform 0.3s ease;
            z-index: 100; display: flex; flex-direction: column;
        }
        #modal.open { transform: translateY(0); }

        /* 20% Header Stats */
        #modal-header {
            height: 20%; min-height: 140px; padding: 20px; display: flex; flex-direction: column;
            border-bottom: 1px solid #232d3d; background: var(--surface); z-index: 10;
        }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .stat-item { text-align: center; background: #0b1118; padding: 10px; border-radius: 8px; border: 1px solid #232d3d; }
        .stat-item label { font-size: 0.65rem; color: #8899a6; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .stat-item span { font-weight: bold; font-family: 'Courier New', monospace; font-size: 1.1rem; }

        /* 80% History (Messenger Style) */
        #modal-history { 
            height: 80%; overflow-y: auto; padding: 20px; 
            display: flex; flex-direction: column; /* Normal flow, but we will scroll to bottom */
        }
        
        .msg-bubble { 
            background: var(--surface); padding: 15px; border-radius: 14px; margin-bottom: 12px; 
            font-size: 0.95rem; line-height: 1.4; border: 1px solid #232d3d;
            max-width: 90%; align-self: flex-start;
        }
        .msg-meta { font-size: 0.7rem; color: #8899a6; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
        
        .status-tag { font-size: 0.6rem; font-weight: 900; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        .tag-EDITED { background: rgba(244, 162, 97, 0.2); color: var(--warn); }
        .tag-DELETED { background: rgba(255, 95, 95, 0.2); color: var(--danger); border: 1px solid var(--danger); }

        #close-btn { position: absolute; top: 15px; right: 15px; background: #1c2531; border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; }

        @media (min-width: 768px) {
            #sidebar { width: 380px; }
            #modal { position: relative; transform: none; display: flex; border-left: 1px solid #232d3d; }
            #close-btn { display: none; }
        }
    </style>
</head>
<body>

<div id="app">
    <div id="sidebar">
        <div style="padding: 25px; border-bottom: 1px solid #232d3d;">
            <h2 style="margin:0; font-size: 1.6rem; letter-spacing: -1px; color: var(--primary);">TRUTHWATCH</h2>
            <div style="display:flex; align-items:center; gap:8px; margin-top:5px;">
                <div style="width:8px; height:8px; background:var(--success); border-radius:50%;"></div>
                <small style="color: #8899a6; font-weight: 600;">VPS_MONITOR_ACTIVE</small>
            </div>
        </div>
        <div id="rank-list"></div>
    </div>

    <div id="modal">
        <button id="close-btn" onclick="closeModal()">✕</button>
        <div id="modal-header">
            <h3 id="current-name" style="margin:0; color: var(--text);">Select Provider</h3>
            <div class="stat-grid">
                <div class="stat-item"><label>Signals</label><span id="s-total">0</span></div>
                <div class="stat-item"><label>Edits</label><span id="s-edit" style="color:var(--warn)">0</span></div>
                <div class="stat-item"><label>Deletes</label><span id="s-del" style="color:var(--danger)">0</span></div>
            </div>
        </div>
        <div id="modal-history">
            </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getFirestore, collection, query, onSnapshot, orderBy, where } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB0-1AGFajfTr03V2K7ycoC4hVbtZN7XA8",
        authDomain: "signal-screenr.firebaseapp.com",
        projectId: "signal-screenr",
        storageBucket: "signal-screenr.firebasestorage.app",
        messagingSenderId: "213700708679",
        appId: "1:213700708679:web:28d05f350b39f4c0afa462"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Sidebar Logic
    onSnapshot(query(collection(db, "archived_messages")), (snap) => {
        const stats = {};
        snap.forEach(doc => {
            const m = doc.data();
            if (!stats[m.channel_name]) stats[m.channel_name] = { total: 0, bad: 0 };
            if (m.is_signal) {
                stats[m.channel_name].total++;
                if (m.status !== "ORIGINAL") stats[m.channel_name].bad++;
            }
        });

        const sorted = Object.keys(stats).map(name => {
            const s = stats[name];
            const score = s.total === 0 ? 100 : Math.round(((s.total - s.bad) / s.total) * 100);
            return { name, score, total: s.total };
        }).sort((a, b) => b.score - a.score);

        const list = document.getElementById('rank-list');
        list.innerHTML = "";
        sorted.forEach(c => {
            const div = document.createElement('div');
            div.className = "channel-card";
            div.innerHTML = `
                <div><strong>${c.name}</strong><br><small style="color:#8899a6">${c.total} Audited</small></div>
                <div class="truth-score">${c.score}%</div>
            `;
            div.onclick = () => loadChannel(c.name);
            list.appendChild(div);
        });
    });

    let currentListener = null;

    window.loadChannel = function(name) {
        document.getElementById('modal').classList.add('open');
        document.getElementById('current-name').innerText = name;
        
        // Use ASCENDING order so newest records are appended to the end (bottom)
        const q = query(collection(db, "archived_messages"), where("channel_name", "==", name), orderBy("timestamp", "asc"));
        
        // Detach previous listener if switching channels
        if (currentListener) currentListener();

        currentListener = onSnapshot(q, (snap) => {
            const history = document.getElementById('modal-history');
            history.innerHTML = "";
            let sTotal = 0, sEdit = 0, sDel = 0;

            snap.forEach(doc => {
                const m = doc.data();
                if (m.is_signal) {
                    sTotal++;
                    if (m.status === "EDITED") sEdit++;
                    if (m.status === "DELETED") sDel++;
                }

                const div = document.createElement('div');
                div.className = `msg-bubble ${m.status === 'DELETED' ? 'deleted-box' : ''}`;
                const statusTag = m.status !== "ORIGINAL" ? `<span class="status-tag tag-${m.status}">${m.status}</span>` : "";
                
                div.innerHTML = `
                    <div class="msg-meta">
                        ${statusTag}
                        <span>${new Date(m.timestamp*1000).toLocaleDateString('en-GB')} • ${new Date(m.timestamp*1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div style="white-space: pre-wrap;">${m.text}</div>
                `;
                history.appendChild(div);
            });

            document.getElementById('s-total').innerText = sTotal;
            document.getElementById('s-edit').innerText = sEdit;
            document.getElementById('s-del').innerText = sDel;

            // PERFORMANCE FIX: Auto-scroll to the bottom immediately after loading
            setTimeout(() => {
                history.scrollTop = history.scrollHeight;
            }, 100);
        });
    };

    window.closeModal = () => document.getElementById('modal').classList.remove('open');
</script>
</body>
</html>