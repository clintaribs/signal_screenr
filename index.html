<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRUTHWATCH | Supabase Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Josefin Sans"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PWA Setup -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b1118">
    <link rel="apple-touch-icon" href="logo.png">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed', err));
            });
        }
    </script>
    <style>
        body {
            font-family: 'Josefin Sans', sans-serif;
        }

        .tag-SIGNAL {
            background: #4b5563;
        }

        .tag-EDITED {
            background: #ffa502;
            color: black;
        }

        .tag-DELETED {
            background: #ff4757;
        }

        .tag-TP_SIGNAL {
            background: #a55eea;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            /* gray-200 */
        }

        .dark ::-webkit-scrollbar-track {
            background: #161d27;
        }

        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            /* gray-400 */
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #232d3d;
        }
    </style>
</head>

<body
    class="bg-gray-100 dark:bg-[#0b1118] text-gray-900 dark:text-[#e0e6ed] fixed inset-0 h-full w-full flex flex-col overflow-hidden font-sans transition-colors duration-200">

    <!-- Mobile Header -->
    <header
        class="md:hidden bg-white dark:bg-black border-b border-gray-200 dark:border-gray-800 p-4 flex justify-between items-center z-20 transition-colors duration-200">
        <div class="flex items-center gap-2">
            <button onclick="toggleMobileMenu()"
                class="text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white mr-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                    </path>
                </svg>
            </button>
            <div class="h-8">
                <img src="logo_light_mode.png" class="h-full block dark:hidden" alt="TruthWatch">
                <img src="logo_dark_mode.png" class="h-full hidden dark:block" alt="TruthWatch">
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="location.reload()"
                class="text-gray-600 dark:text-gray-300 p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
            </button>
            <button onclick="toggleTheme()"
                class="text-xl p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 transition">
                <span class="dark:hidden">üåô</span>
                <span class="hidden dark:inline">‚òÄÔ∏è</span>
            </button>
        </div>
    </header>

    <div class="flex flex-grow overflow-hidden relative">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed inset-y-0 left-0 md:relative w-80 h-full border-r border-gray-200 dark:border-gray-800 flex flex-col bg-white dark:bg-black transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 pt-0 md:pt-0 shadow-2xl md:shadow-none transition-colors duration-200">
            <div class="p-6 border-b border-gray-200 dark:border-gray-800 hidden md:block">
                <div class="flex justify-between items-center mb-4">
                    <div class="h-10">
                        <img src="logo_light_mode.png" class="h-full block dark:hidden" alt="TruthWatch">
                        <img src="logo_dark_mode.png" class="h-full hidden dark:block" alt="TruthWatch">
                    </div>
                </div>
                <div class="flex items-center space-x-2 mb-4">
                    <button onclick="location.reload()"
                        class="flex-1 flex items-center justify-center gap-2 p-2 bg-gray-100 dark:bg-gray-900 rounded hover:bg-gray-200 dark:hover:bg-gray-800 transition text-sm font-semibold border border-gray-200 dark:border-gray-800">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        Reload
                    </button>
                    <button onclick="toggleTheme()"
                        class="p-2 bg-gray-100 dark:bg-gray-900 rounded hover:bg-gray-200 dark:hover:bg-gray-800 transition border border-gray-200 dark:border-gray-800">
                        <span class="dark:hidden">üåô</span>
                        <span class="hidden dark:inline">‚òÄÔ∏è</span>
                    </button>
                </div>

                <button onclick="openLeaderboard()"
                    class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold transition shadow-lg shadow-blue-500/20 text-sm uppercase tracking-wide">
                    üèÜ Global Leaderboard
                </button>
            </div>
            <div class="p-4 md:hidden flex justify-between items-center border-b border-[#232d3d]">
                <span class="font-bold">Channels</span>
                <button onclick="toggleMobileMenu()"
                    class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <!-- Mobile Leaderboard Button -->
            <div class="md:hidden p-4">
                <button onclick="openLeaderboard()"
                    class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded font-bold transition">üèÜ
                    Leaderboard</button>
            </div>

            <div id="channel-list" class="flex-grow overflow-y-auto p-2 space-y-1"></div>
        </aside>

        <!-- Overlay for mobile sidebar -->
        <div id="mobile-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden">
        </div>

        <!-- Main Content -->
        <main
            class="flex-grow flex flex-col relative w-full bg-gray-50 dark:bg-[#0b1118] transition-colors duration-200">
            <header
                class="p-4 bg-white dark:bg-[#161d27] border-b border-gray-200 dark:border-[#232d3d] flex justify-between items-center shadow-md z-10 transition-colors duration-200">
                <div>
                    <h2 id="active-title"
                        class="text-xl font-semibold truncate max-w-[200px] text-gray-900 dark:text-white">Select
                        Provider</h2>
                    <div id="active-score" class="text-sm text-gray-500"></div>
                </div>
                <div id="header-btns" class="hidden flex space-x-2">
                    <button onclick="openStats()"
                        class="bg-gray-100 hover:bg-gray-200 dark:bg-[#232d3d] dark:hover:bg-[#2f3b4f] px-3 py-2 rounded border border-gray-300 dark:border-[#3e4d5e] transition text-sm text-gray-700 dark:text-gray-300">üìä</button>
                    <button onclick="openPerf()"
                        class="bg-gray-100 hover:bg-gray-200 dark:bg-[#232d3d] dark:hover:bg-[#2f3b4f] px-3 py-2 rounded border border-gray-300 dark:border-[#3e4d5e] transition text-sm text-gray-700 dark:text-gray-300">üìà</button>
                    <button onclick="openEquity()"
                        class="bg-gray-100 hover:bg-gray-200 dark:bg-[#232d3d] dark:hover:bg-[#2f3b4f] px-3 py-2 rounded border border-gray-300 dark:border-[#3e4d5e] transition text-sm text-gray-700 dark:text-gray-300">üí∞</button>
                </div>
            </header>

            <div id="feed" class="flex-grow p-4 md:p-6 overflow-y-auto flex flex-col space-y-4">
                <div class="text-center text-gray-600 mt-20">Select a channel to view auditable signals.</div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-bg"
        class="fixed inset-0 bg-black/50 dark:bg-black/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm"
        onclick="closeModal(event)">
        <div class="bg-white dark:bg-[#161d27] w-full max-w-3xl rounded-xl border border-gray-200 dark:border-blue-500/30 shadow-2xl flex flex-col max-h-[85vh] transition-colors duration-200"
            onclick="event.stopPropagation()">
            <div
                class="p-6 border-b border-gray-200 dark:border-[#232d3d] flex justify-between items-center bg-gray-50 dark:bg-[#1c2531] rounded-t-xl transition-colors duration-200">
                <h2 id="modal-title" class="text-xl md:text-2xl font-bold truncate text-gray-900 dark:text-white">
                    Details</h2>
                <button onclick="closeModal()"
                    class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-content" class="p-4 md:p-8 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://pbxxmbntchgmwencefdr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBieHhtYm50Y2hnbXdlbmNlZmRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTQ1NjAsImV4cCI6MjA4NDE3MDU2MH0.pD6IHRH9_XyA3f3YrrftjPZ4xLFlGc6WE6lLiF06r4Y";

        // Fix: createClient is inside the supabase global object from CDN
        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        let allData = [];
        let providerStats = {};
        let currentChannel = "";

        // Toggle Theme
        window.toggleTheme = () => {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Init Theme
        if (localStorage.getItem('theme') === 'light') {
            document.documentElement.classList.remove('dark');
        }

        // Mobile Toggle
        window.toggleMobileMenu = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // Fetch Initial Data (Get last 2000 messages to ensure recent ones shown)
        async function init() {
            const { data: msgs } = await dbClient
                .from('archived_messages')
                .select('*')
                .order('timestamp', { ascending: false })
                .limit(2000);

            if (msgs) allData = msgs;

            const { data: stats } = await dbClient.from('provider_stats').select('*');
            if (stats) stats.forEach(s => providerStats[s.channel_name] = s);

            renderChannels();

            // Auto Select Top Active Channel
            if (!currentChannel) {
                const sorted = Object.values(providerStats)
                    .filter(s => s.active === true)
                    .sort((a, b) => b.score - a.score);
                if (sorted.length > 0) {
                    selectChannel(sorted[0].channel_name);
                }
            }

            // Realtime Subscription
            dbClient.channel('public:archived_messages')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'archived_messages' }, payload => {
                    if (payload.eventType === 'INSERT') {
                        allData.push(payload.new);
                    } else if (payload.eventType === 'UPDATE') {
                        const idx = allData.findIndex(d => d.msg_id === payload.new.msg_id);
                        if (idx > -1) allData[idx] = payload.new;
                    } else if (payload.eventType === 'DELETE') {
                        // Note: Payload.old only has ID usually
                        allData = allData.filter(d => d.msg_id !== payload.old.msg_id);
                    }

                    if (currentChannel) {
                        renderFeed();
                        // If Performance Modal is Open, Refresh it
                        const modalTitle = document.getElementById('modal-title');
                        const modalBg = document.getElementById('modal-bg');
                        if (!modalBg.classList.contains('hidden') && modalTitle.innerText === "Trade Performance") {
                            openPerf();
                        }
                    }
                    renderChannels();
                })
                .subscribe();

            dbClient.channel('public:provider_stats')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'provider_stats' }, payload => {
                    if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                        providerStats[payload.new.channel_name] = payload.new;
                    }
                    renderChannels();
                    if (currentChannel) updateHeaderStats();
                })
                .subscribe();
        }
        init();

        window.selectChannel = async (name) => {
            currentChannel = name;
            // Mark as Read
            localStorage.setItem('lastRead_' + name, Date.now() / 1000);

            document.getElementById('active-title').innerText = name + " (Loading...)";

            // FETCH FULL HISTORY for this channel 
            // (Frontend init only gets 2000 global, we need ALL for accurate stats/feed)
            await fetchChannelHistory(name);

            document.getElementById('active-title').innerText = name;
            document.getElementById('header-btns').classList.remove('hidden');
            updateHeaderStats();
            renderFeed();
            renderChannels();

            // Close mobile menu if open
            if (!document.getElementById('sidebar').classList.contains('-translate-x-full')) {
                toggleMobileMenu();
            }
        };

        async function fetchChannelHistory(name) {
            const { data, error } = await dbClient
                .from('archived_messages')
                .select('*')
                .eq('channel_name', name)
                .order('timestamp', { ascending: true }); // Oldest first for feed sort? Or just sort in RAM.

            if (data) {
                // Merge into allData (avoid duplicates)
                // We use a Map or just filter out existing?
                // Easier: Remove existing for this channel and replace with full fetch
                allData = allData.filter(d => d.channel_name !== name);
                allData = [...allData, ...data];
            }
        }

        function updateHeaderStats() {
            const stats = providerStats[currentChannel];
            const score = stats ? stats.score : 100;
            const scoreColor = score < 80 ? 'text-red-500' : 'text-green-400';

            document.getElementById('active-score').innerHTML = `
                <div class="flex items-center space-x-4">
                    <span>Truth Score: <span class="${scoreColor} font-bold">${score}</span></span>
                    <button onclick="requestSync()" class="p-1 px-3 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded shadow transition flex items-center gap-1" title="Force Sync & Recalculate Stats">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Sync
                    </button>
                </div>
            `;
        }

        window.requestSync = async () => {
            if (!currentChannel) return;
            const btn = document.querySelector("#active-score button");
            if (btn) btn.innerHTML = '...';

            // Set force_sync = true in DB
            await dbClient.from('provider_stats').update({ force_sync: true }).eq('channel_name', currentChannel);

            // Wait a bit to prevent spam
            setTimeout(() => {
                if (btn) btn.innerHTML = `
                 <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                 Sync`;
            }, 2000);
        };

        function renderChannels() {
            const list = document.getElementById('channel-list');
            list.innerHTML = '';

            // Collect all unique channel names from messages and stats
            const msgChannels = new Set(allData.map(d => d.channel_name));
            const statChannels = new Set(Object.keys(providerStats));
            const allChannelNames = [...new Set([...msgChannels, ...statChannels])];

            // Sort by Score (High to Low)
            const sortedChannels = allChannelNames
                .filter(ch => {
                    const s = providerStats[ch];
                    // STRICT filtering: 
                    // 1. Must exist in providerStats (implies it was discovered/synced)
                    // 2. active must be true
                    // Fallback: If no stats exist yet (rare race condition), we hide it to be safe, 
                    // or show it if it has recent messages? 
                    // BETTER: Trust the backend sync. If backend says active=false (or missing), hide it.
                    if (!s) return false;
                    return s.active === true;
                })
                .sort((a, b) => {
                    const scoreA = providerStats[a]?.score || 0;
                    const scoreB = providerStats[b]?.score || 0;
                    return scoreB - scoreA;
                });

            sortedChannels.forEach(channel => {
                const stats = providerStats[channel] || { score: 0 }; // Default score if no stats
                const isActive = channel === currentChannel;

                const div = document.createElement('div');
                div.className = `p-3 rounded mx-2 cursor-pointer flex justify-between items-center transition ${isActive ? 'bg-gray-200 dark:bg-[#232d3d] border-l-4 border-blue-500 text-blue-600 dark:text-blue-400' : 'hover:bg-gray-100 dark:hover:bg-[#1c2531] border-l-4 border-transparent text-gray-600 dark:text-gray-400'}`;
                div.onclick = () => {
                    selectChannel(channel);
                    if (window.innerWidth < 768) toggleMobileMenu(); // Auto-close on mobile
                };

                const lastRead = parseFloat(localStorage.getItem('lastRead_' + channel) || '0');
                const channelMsgs = allData.filter(m => m.channel_name === channel);
                const lastMsgTime = channelMsgs.length > 0 ? Math.max(...channelMsgs.map(m => m.timestamp)) : 0;
                const hasUnread = lastMsgTime > lastRead;

                div.innerHTML = `
                    <div class="flex items-center space-x-2 overflow-hidden">
                        ${hasUnread ? '<div class="w-2 h-2 rounded-full bg-red-500 flex-shrink-0 animate-pulse"></div>' : ''}
                        <span class="font-medium truncate max-w-[140px]">${channel}</span>
                    </div>
                    <span class="text-xs font-bold ${stats.score < 80 ? 'text-red-500' : 'text-green-500'} bg-black/5 dark:bg-black/30 px-2 py-1 rounded flex-shrink-0">${stats.score}</span>
                `;
                list.appendChild(div);
            });
        }

        function renderFeed() {
            const feed = document.getElementById('feed');
            const msgs = allData.filter(m => m.channel_name === currentChannel).sort((a, b) => a.timestamp - b.timestamp);

            if (msgs.length === 0) {
                feed.innerHTML = '<div class="text-center text-gray-500 mt-10">No messages found.</div>';
                return;
            }

            feed.innerHTML = msgs.map(m => {
                const time = new Date(m.timestamp * 1000).toLocaleString('en-GB', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });

                let tagsHtml = '';
                if (m.is_signal) tagsHtml += `<span class="tag-SIGNAL text-[10px] px-2 py-0.5 rounded font-bold mr-2">SIGNAL</span>`;
                if (m.status === 'EDITED') tagsHtml += `<span class="tag-EDITED text-[10px] px-2 py-0.5 rounded font-bold mr-2">EDITED</span>`;
                if (m.status === 'DELETED') tagsHtml += `<span class="tag-DELETED text-[10px] px-2 py-0.5 rounded font-bold mr-2 text-white">DELETED</span>`;
                if (m.tags && m.tags.includes('TP_SIGNAL')) tagsHtml += `<span class="tag-TP_SIGNAL text-[10px] px-2 py-0.5 rounded font-bold text-white mr-2">TP_SIGNAL</span>`;
                if (m.tags && m.tags.includes('EVIL')) tagsHtml += `<span class="bg-red-700 text-[10px] px-2 py-0.5 rounded font-bold text-white mr-2 shadow-sm uppercase tracking-wide">EVIL</span>`;
                if (m.tags && m.tags.includes('ERROR')) tagsHtml += `<span class="bg-gray-700 text-[10px] px-2 py-0.5 rounded font-mono text-white mr-2 border border-gray-500">ERROR</span>`;

                let details = '';
                if (m.is_signal && m.entry) {
                    details = `<div class="mt-2 text-xs text-blue-600 dark:text-blue-300 font-mono bg-gray-100 dark:bg-black/20 p-2 rounded inline-block w-full overflow-x-auto">
                    ${m.action} @ ${m.entry} | TP: ${m.tp || '--'} | SL: ${m.sl || '--'} | Mkt: ${m.market_at_time || '--'}
                </div>`;
                }

                return `<div class="bg-white dark:bg-[#161d27] p-4 rounded-lg border border-gray-200 dark:border-[#232d3d] self-start w-full max-w-3xl hover:border-blue-500/30 transition shadow-sm">
                <div class="text-[11px] text-gray-500 mb-2 flex flex-wrap items-center justify-between gap-2">
                    <div>${time}</div>
                    <div class="flex flex-wrap gap-1">${tagsHtml}</div>
                </div>
                <div class="whitespace-pre-wrap text-sm leading-relaxed break-words text-gray-700 dark:text-gray-300">${m.text || "[Content Deleted]"}</div>
                ${details}
            </div>`;
            }).join('') + '<div class="h-0 w-full flex-shrink-0"></div>'; // Add explicit spacer at bottom
            feed.scrollTop = feed.scrollHeight;
        }

        window.closeModal = (e) => {
            if (!e || e.target.id === 'modal-bg' || !e.target.closest('#modal-content')) {
                document.getElementById('modal-bg').classList.add('hidden');
            }
        };
        document.querySelector('button[onclick="closeModal()"]').onclick = () => document.getElementById('modal-bg').classList.add('hidden');

        window.openLeaderboard = () => {
            const sorted = Object.entries(providerStats)
                .filter(([, s]) => s.active !== false)
                .sort(([, a], [, b]) => b.score - a.score);

            document.getElementById('modal-title').innerText = "Global Leaderboard";
            document.getElementById('modal-content').innerHTML = `
            <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse min-w-[600px]">
                <thead>
                    <tr class="text-gray-500 border-b border-gray-200 dark:border-[#232d3d] text-xs uppercase tracking-wider">
                        <th class="p-3">Rank</th>
                        <th class="p-3">Provider</th>
                        <th class="p-3 text-center">Score</th>
                        <th class="p-3 text-center">Rate</th>
                        <th class="p-3 text-center">Wins</th>
                        <th class="p-3 text-center">Loss</th>
                        <th class="p-3 text-center">Net Pips</th>
                        <th class="p-3 text-center">Trades</th>
                        <th class="p-3 text-center">TP Sigs</th>
                        <th class="p-3 text-center">Evil</th>
                        <th class="p-3 text-center">Errors</th>
                        <th class="p-3 text-center">Edits</th>
                        <th class="p-3 text-center">Deletes</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    ${sorted.map(([name, s], i) => `
                        <tr class="border-b border-gray-100 dark:border-[#232d3d] hover:bg-gray-50 dark:hover:bg-[#1c2531] transition-colors">
                            <td class="p-3 font-mono text-gray-400">#${i + 1}</td>
                            <td class="p-3 font-bold text-blue-600 dark:text-blue-400 whitespace-nowrap">${name}</td>
                            <td class="p-3 text-center font-bold ${s.score >= 80 ? 'text-green-500' : 'text-red-500'}">${s.score}</td>
                            <td class="p-3 text-center font-bold text-yellow-500">${s.win_rate != null ? s.win_rate + '%' : 'N/A'}</td>
                            <td class="p-3 text-center font-bold text-green-500">${s.wins}</td>
                            <td class="p-3 text-center font-bold text-red-500">${s.losses}</td>
                            <td class="p-3 text-center font-bold ${s.net_profit >= 0 ? 'text-green-500' : 'text-red-500'}">${s.net_profit != null ? (s.net_profit > 0 ? '+' : '') + s.net_profit : '--'}</td>
                            <td class="p-3 text-center text-gray-700 dark:text-gray-300">${s.total || 0}</td>
                            <td class="p-3 text-center text-purple-500 font-bold">${s.tp_signals || 0}</td>
                            <td class="p-3 text-center text-red-600 font-extrabold">${s.evil_signals || 0}</td>
                            <td class="p-3 text-center text-gray-500 font-bold">${s.errors || 0}</td>
                            <td class="p-3 text-center text-orange-400 font-bold">${s.edits || 0}</td>
                            <td class="p-3 text-center text-red-500 font-bold">${s.deletes || 0}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            </div>`;
            document.getElementById('modal-bg').classList.remove('hidden');
            if (!document.getElementById('sidebar').classList.contains('-translate-x-full')) {
                toggleMobileMenu();
            }
        };

        window.openStats = () => {
            const stats = providerStats[currentChannel] || { score: 100, edits: 0, deletes: 0, tp_signals: 0 };
            const sigs = allData.filter(m => m.channel_name === currentChannel && m.is_signal).length;

            document.getElementById('modal-title').innerText = `${currentChannel} Stats`;
            document.getElementById('modal-content').innerHTML = `
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">${sigs}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Signals</div>
                </div>
                <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold ${stats.score >= 80 ? 'text-green-500' : 'text-red-500'}">${stats.score}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Score</div>
                </div>
                 <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-yellow-500">${stats.win_rate != null ? stats.win_rate + '%' : 'N/A'}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Win Rate</div>
                </div>
                 <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-purple-500">${stats.tp_signals || 0}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">TP Signals</div>
                </div>
                <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-green-500">${stats.wins || 0}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Wins</div>
                </div>
                <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-red-500">${stats.losses || 0}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Losses</div>
                </div>
                <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-red-600">${stats.evil_signals || 0}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">EVIL</div>
                </div>
                <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-gray-500">${stats.errors || 0}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Errors</div>
                </div>
                 <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-orange-400">${stats.edits}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Edits</div>
                </div>
                <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-red-500">${stats.deletes}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Deletes</div>
                </div>
            </div>`;
            document.getElementById('modal-bg').classList.remove('hidden');
        };

        window.openPerf = () => {
            const sigs = allData.filter(m => m.channel_name === currentChannel && m.is_signal).sort((a, b) => a.timestamp - b.timestamp);

            document.getElementById('modal-title').innerText = "Trade Performance";
            document.getElementById('modal-content').innerHTML = `
            <div class="space-y-4">
                ${sigs.length === 0 ? '<div class="text-gray-500 text-center">No trades recorded.</div>' : ''}
                ${sigs.map((s, i) => {
                const isWin = s.outcome === 'WIN';
                const isLoss = s.outcome === 'LOSS';
                const isBuy = s.action === 'BUY';
                const borderClass = isWin ? 'border-green-500' : isLoss ? 'border-red-500' : 'border-blue-500';
                const outcomeClass = isWin ? 'text-green-500' : isLoss ? 'text-red-500' : 'text-blue-500';
                const typeClass = isBuy ? 'text-green-600 dark:text-green-400 bg-green-500/10' : 'text-red-600 dark:text-red-400 bg-red-500/10';

                // Display Logic
                // USER FIX: Use market_at_time (Real Price) if available, else s.entry
                const realEntry = parseFloat(s.market_at_time || s.entry);
                const runPips = (s.max_run_pips || 0).toFixed(2);
                let lossPips = "0.00";

                // Calculate Loss Pips if LOSS
                if (isLoss && s.sl && realEntry) {
                    // Gold: $1 = 10 pips. 0.10 = 1 pip.
                    // Diff * 10 = Pips.
                    const diff = Math.abs(realEntry - s.sl);
                    // Asset specific multiplier (Assume Gold/Default is 10x for price-to-pips)
                    // If J75 (Indices), it might be 1:1. 
                    const multiplier = (s.asset === 'J75') ? 1 : 10;
                    lossPips = (diff * multiplier).toFixed(2);
                }

                // PERFORMANCE TAGS
                let tagsHtml = '';
                if (s.tags && s.tags.includes('TP_SIGNAL')) tagsHtml += `<span class="text-[10px] bg-purple-600 text-white px-1.5 py-0.5 rounded font-bold ml-2">TP_SIGNAL</span>`;
                if (s.tags && s.tags.includes('EVIL')) tagsHtml += `<span class="text-[10px] bg-red-700 text-white px-1.5 py-0.5 rounded font-bold ml-2 shadow-sm uppercase">EVIL</span>`;
                if (s.tags && s.tags.includes('ERROR')) tagsHtml += `<span class="text-[10px] bg-gray-500 text-white px-1.5 py-0.5 rounded font-bold ml-2">ERROR</span>`;

                return `
                    <div class="bg-white dark:bg-[#0b1118] p-4 rounded border-l-4 ${borderClass} flex flex-col md:flex-row justify-between items-start md:items-center shadow-lg transition-colors border max-w-full">
                        <div class="mb-2 md:mb-0 w-full">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="bg-gray-100 dark:bg-[#1c2531] text-gray-500 dark:text-gray-400 px-2 py-0.5 rounded text-xs font-mono font-bold">#${i + 1}</span>
                                    <span class="px-3 py-1 rounded font-bold text-xs md:text-xs uppercase ${typeClass} tracking-wide border border-current">${s.action} ${s.asset || 'GOLD'}</span>
                                    ${tagsHtml}
                                </div>
                                <span class="text-xs text-gray-500">${new Date(s.timestamp * 1000).toLocaleString('en-GB')}</span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm md:text-xs font-mono text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-[#161d27] p-2 rounded">
                                <div><span class="text-gray-500 dark:text-gray-600 block text-[10px] uppercase">Entry</span>${s.entry}</div>
                                <div><span class="text-gray-500 dark:text-gray-600 block text-[10px] uppercase">TP</span>${s.tp || '--'}</div>
                                <div><span class="text-gray-500 dark:text-gray-600 block text-[10px] uppercase">SL</span>${s.sl || '--'}</div>
                                <div><span class="text-gray-500 dark:text-gray-600 block text-[10px] uppercase">Mkt Price</span>${s.market_at_time || '--'}</div>
                            </div>
                        </div>
                        <div class="text-right md:ml-6 min-w-[100px] mt-3 md:mt-0 border-t md:border-t-0 border-[#232d3d] pt-3 md:pt-0 flex flex-col items-end">
                             <div class="text-xl md:text-2xl font-bold ${outcomeClass}">${s.outcome}</div>
                            <div class="text-xs text-gray-500">Peak: <span class="${runPips > 0 ? 'text-green-400' : 'text-gray-400'}">+${runPips} pips</span></div>
                            ${isLoss ? `<div class="text-xs text-red-500 mt-0.5">Loss: -${lossPips} pips</div>` : ''}
                            
                            ${s.outcome === 'LIVE' ? `
                            <button onclick="refreshSignal(${s.msg_id})" class="mt-2 text-xs bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 px-2 py-1 rounded border border-blue-600/50 transition flex items-center gap-1" title="Ping MT5 Update">
                                üîÑ Update
                            </button>` : ''}
                        </div>
                    </div>`;
            }).join('')
                }
            </div > `;
            document.getElementById('modal-bg').classList.remove('hidden');
        };

        let equityChartInstance = null;
        window.openEquity = () => {
            const savedBalance = localStorage.getItem('eq_balance') || 10000;
            const savedRisk = localStorage.getItem('eq_risk') || 1;
            const savedTp = localStorage.getItem('eq_tp') || 20;
            const savedSl = localStorage.getItem('eq_sl') || ""; // Default empty (use provider)

            document.getElementById('modal-title').innerText = "Dynamic Performance Calculator";
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-6">
                    
                    <div class="bg-white dark:bg-[#0b1118] p-4 rounded-lg border border-gray-200 dark:border-[#232d3d] shadow-sm relative h-64">
                        <canvas id="equityChart"></canvas>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                             <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Starting Balance</label>
                             <input type="number" id="eq-balance" value="${savedBalance}" onchange="calcEquity()" class="w-full bg-gray-50 dark:bg-[#0b1118] border border-gray-200 dark:border-[#232d3d] rounded p-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:border-blue-500 font-mono">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Sim Mode</label>
                            <select id="eq-sim-mode" onchange="toggleSimMode()" class="w-full bg-gray-50 dark:bg-[#0b1118] border border-gray-200 dark:border-[#232d3d] rounded p-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
                                <option value="QUICK">‚ö° Quick (Estimator)</option>
                                <option value="SCIENTIFIC">üî¨ Scientific (Real Tick)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Risk Mode</label>
                            <select id="eq-risk-mode" onchange="updateRiskLabel()" class="w-full bg-gray-50 dark:bg-[#0b1118] border border-gray-200 dark:border-[#232d3d] rounded p-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
                                <option value="PERCENT">Risk Percentage (%)</option>
                                <option value="FIXED">Fixed Lot Size</option>
                                <option value="DYNAMIC">Dynamic (Entry Quality)</option>
                            </select>
                        </div>
                         <div>
                            <label id="lbl-risk-val" class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Risk per Trade (%)</label>
                            <input type="number" id="eq-risk" value="${savedRisk}" step="0.1" onchange="calcEquity()" class="w-full bg-gray-50 dark:bg-[#0b1118] border border-gray-200 dark:border-[#232d3d] rounded p-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:border-blue-500 font-mono">
                        </div>
                         <div>
                            <label class="block text-xs text-purple-500 font-bold mb-1">Target TP (Pips)</label>
                            <input type="number" id="eq-tp" value="${savedTp}" step="1" onchange="calcEquity()" class="w-full bg-gray-50 dark:bg-[#0b1118] border border-purple-500/30 dark:border-purple-500/50 rounded p-2 text-sm text-gray-900 dark:text-white focus:border-purple-500 outline-none transition font-mono">
                        </div>
                        <div>
                            <label class="block text-xs text-red-500 font-bold mb-1">Custom SL (Pips)</label>
                            <input type="number" id="eq-sl" value="${savedSl}" placeholder="Provider SL" step="1" onchange="calcEquity()" class="w-full bg-gray-50 dark:bg-[#0b1118] border border-red-500/30 dark:border-red-500/50 rounded p-2 text-sm text-gray-900 dark:text-white focus:border-red-500 outline-none transition font-mono">
                        </div>
                    </div>
                    


                    <button id="btn-run-sim" onclick="calcEquity()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold shadow-lg transition-all flex items-center justify-center gap-2">
                        <span>‚ñ∂ Start Simulation</span>
                    </button>

                    <div class="grid grid-cols-4 gap-2 md:gap-4 text-center">
                        <div class="p-3 bg-gray-50 dark:bg-[#0b1118] rounded border border-gray-200 dark:border-[#232d3d]">
                            <div class="text-[10px] text-gray-500 mb-1 uppercase">Win Rate</div>
                            <div id="eq-rate" class="text-lg font-bold text-yellow-500 font-mono">0%</div>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-[#0b1118] rounded border border-gray-200 dark:border-[#232d3d]">
                            <div class="text-[10px] text-gray-500 mb-1 uppercase">Wins</div>
                            <div id="eq-wins" class="text-lg font-bold text-green-500 font-mono">0</div>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-[#0b1118] rounded border border-gray-200 dark:border-[#232d3d]">
                            <div class="text-[10px] text-gray-500 mb-1 uppercase">Losses</div>
                            <div id="eq-losses" class="text-lg font-bold text-red-500 font-mono">0</div>
                        </div>
                        <div class="p-3 bg-gray-50 dark:bg-[#0b1118] rounded border border-gray-200 dark:border-[#232d3d]">
                            <div class="text-[10px] text-gray-500 mb-1 uppercase">Net Pips</div>
                            <div id="eq-pips" class="text-lg font-bold text-blue-500 font-mono">0</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 text-center border-t border-gray-200 dark:border-[#232d3d] pt-4">
                        <div>
                            <div class="text-xs text-gray-500 mb-1">Total Trades</div>
                            <div id="eq-total" class="text-xl font-bold text-gray-900 dark:text-white font-mono">0</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">Max Drawdown</div>
                            <div id="eq-dd" class="text-xl font-bold text-red-500 font-mono">0%</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">Final Balance</div>
                            <div id="eq-final" class="text-xl font-bold text-green-500 font-mono">$0</div>
                        </div>
                    </div>
                    <div id="sim-status" class="text-[10px] text-gray-400 text-center italic hidden">
                        Initializing...
                    </div>
                </div>
                `;
            document.getElementById('modal-bg').classList.remove('hidden');

            // Helper to toggle UI
            window.toggleSimMode = () => {
                const mode = document.getElementById('eq-sim-mode').value;
                const btn = document.getElementById('btn-run-sim');
                if (mode === 'SCIENTIFIC') {
                    btn.innerText = "üî¨ Run Tick Simulation (Slow)";
                    btn.classList.replace('bg-blue-600', 'bg-purple-600');
                    btn.classList.replace('hover:bg-blue-700', 'hover:bg-purple-700');
                } else {
                    btn.innerText = "‚ö° Quick Estimate";
                    btn.classList.replace('bg-purple-600', 'bg-blue-600');
                    btn.classList.replace('hover:bg-purple-700', 'hover:bg-blue-700');
                }
            };

            window.updateRiskLabel = () => {
                const mode = document.getElementById('eq-risk-mode').value;
                const lbl = document.getElementById('lbl-risk-val');
                if (mode === 'FIXED' || mode === 'DYNAMIC') lbl.innerText = "Base Lot Size";
                else lbl.innerText = "Risk % per Trade";
            };

            // Init UI
            calcEquity();
        };

        window.calcEquity = async () => {
            const balanceStart = parseFloat(document.getElementById('eq-balance').value) || 10000;
            const riskVal = parseFloat(document.getElementById('eq-risk').value) || 1;
            const targetTp = parseFloat(document.getElementById('eq-tp').value) || 20;
            const customSl = parseFloat(document.getElementById('eq-sl').value);
            const simMode = document.getElementById('eq-sim-mode').value;
            const riskMode = document.getElementById('eq-risk-mode').value;

            localStorage.setItem('eq_balance', balanceStart);
            localStorage.setItem('eq_risk', riskVal);
            localStorage.setItem('eq_tp', targetTp);
            localStorage.setItem('eq_sl', document.getElementById('eq-sl').value);

            if (simMode === 'SCIENTIFIC') {
                await runScientificSim(balanceStart, riskVal, targetTp, customSl, riskMode);
                return;
            }

            // --- QUICK MODE (Frontend) ---
            const statusDiv = document.getElementById('sim-status');
            statusDiv.classList.remove('hidden');
            statusDiv.innerText = "Running Quick Estimate...";

            try {
                console.log(`[QuickSim] Starting for Channel: ${currentChannel}`);
                console.log(`[QuickSim] Base Balance: ${balanceStart}, Risk: ${riskVal}`);
                console.log(`[QuickSim] Total Global Data: ${allData.length}`);

                // Filter Valid Signals
                const sigs = allData
                    .filter(m => {
                        if (m.channel_name !== currentChannel) return false;
                        if (!m.is_signal) return false;
                        if (m.outcome === 'ERROR' || (m.tags && m.tags.includes('ERROR'))) return false;
                        // Loose check for LIVE: If max_run exists, use it.
                        if (m.outcome === 'LIVE' && (m.max_run_pips || 0) < targetTp) {
                            // console.log("Skipping pending live trade:", m.msg_id);
                            return false;
                        }
                        return true;
                    })
                    .sort((a, b) => a.timestamp - b.timestamp);

                console.log(`[QuickSim] Filtered Signals: ${sigs.length}`);
                if (sigs.length === 0) {
                    statusDiv.innerText = "‚ö†Ô∏è No eligible signals found (Check Filter/Channel).";
                    return;
                }

                let balance = balanceStart;
                let maxBalance = balanceStart;
                let maxDD = 0;
                const dataPoints = [balanceStart];
                const labels = ['Start'];

                let simWins = 0;
                let simLosses = 0;
                let netPips = 0;

                sigs.forEach((s, i) => {
                    const riskAmount = balance * (riskVal / 100);
                    const maxRun = s.max_run_pips || 0;

                    // Determine Risk Pips (Provider vs Custom)
                    let riskPips = 0;
                    if (!isNaN(customSl) && customSl > 0) {
                        riskPips = customSl;
                    } else if (s.sl && s.entry) {
                        // Calc Provider Risk
                        const diff = Math.abs((s.market_at_time || s.entry) - s.sl);
                        const multiplier = (s.asset === 'J75') ? 1 : 10;
                        riskPips = diff * multiplier;
                    } else {
                        riskPips = 50; // Fallback default risk if undetermined
                    }
                    if (riskPips < 5) riskPips = 50; // Safety floor

                    // Determine Outcome
                    if (maxRun >= targetTp) {
                        // WIN
                        // Profit = RiskAmount * (Reward / Risk)
                        const profit = riskAmount * (targetTp / riskPips);
                        balance += profit;
                        simWins++;
                        netPips += targetTp;
                    } else {
                        // LOSS
                        // Loss = RiskAmount (1R)
                        balance -= riskAmount;
                        simLosses++;
                        netPips -= riskPips;
                    }

                    if (balance > maxBalance) maxBalance = balance;
                    if (balance <= 0) balance = 0;
                    const dd = maxBalance > 0 ? ((maxBalance - balance) / maxBalance) * 100 : 0;
                    if (dd > maxDD) maxDD = dd;

                    dataPoints.push(balance);
                    labels.push(`#${i + 1}`);
                });

                // Update Stats
                const total = simWins + simLosses;
                const winRate = total > 0 ? ((simWins / total) * 100).toFixed(1) : "0.0";

                document.getElementById('eq-rate').innerText = winRate + '%';
                document.getElementById('eq-wins').innerText = simWins;
                document.getElementById('eq-losses').innerText = simLosses;
                document.getElementById('eq-pips').innerText = userFormat(netPips);
                document.getElementById('eq-pips').className = `text-lg font-bold font-mono ${netPips >= 0 ? 'text-blue-500' : 'text-red-500'}`;

                document.getElementById('eq-total').innerText = total;
                document.getElementById('eq-dd').innerText = maxDD.toFixed(2) + '%';
                document.getElementById('eq-final').innerText = '$' + balance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('eq-final').className = `text-xl font-bold font-mono ${balance >= balanceStart ? 'text-green-500' : 'text-red-500'}`;

                statusDiv.innerText = "Quick Estimate Complete.";
                renderChart(labels, dataPoints, balance >= balanceStart, document.documentElement.classList.contains('dark'));

            } catch (err) {
                console.error(err);
                statusDiv.innerText = "‚ö†Ô∏è Error in Quick Estimate: " + err.message;
            }
        };

        async function runScientificSim(balance, riskVal, tp, sl, riskMode) {
            const statusDiv = document.getElementById('sim-status');
            const btn = document.getElementById('btn-run-sim');

            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<span class="animate-pulse">üî¨ Requesting Simulation Engine...</span>';
            btn.disabled = true;
            btn.classList.add('opacity-50');

            try {
                // 1. Submit Job
                const { data: job, error } = await dbClient
                    .from('simulation_requests')
                    .insert({
                        channel_name: currentChannel,
                        params: {
                            balance: balance,
                            risk_val: riskVal,
                            risk_mode: riskMode,
                            tp: tp,
                            sl: sl
                        },
                        status: 'PENDING'
                    })
                    .select()
                    .single();

                if (error) throw error;

                // 2. Poll for Result
                let attempts = 0;
                const maxAttempts = 60;

                const poll = setInterval(async () => {
                    attempts++;
                    statusDiv.innerHTML = `<span class="animate-pulse">‚è≥ Simulating Trades... (${attempts}s)</span>`;

                    const { data: updated } = await dbClient
                        .from('simulation_requests')
                        .select('*')
                        .eq('id', job.id)
                        .single();

                    if (updated && updated.status === 'COMPLETED') {
                        clearInterval(poll);
                        displaySimResults(updated.result);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(poll);
                        statusDiv.innerText = "‚ùå Simulation Timed Out.";
                        btn.disabled = false;
                        btn.classList.remove('opacity-50');
                    }
                }, 1000);

            } catch (err) {
                console.error(err);
                statusDiv.innerText = "‚ùå Error starting simulation: " + (err.message || JSON.stringify(err));
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        function displaySimResults(res) {
            const btn = document.getElementById('btn-run-sim');
            btn.disabled = false;
            btn.classList.remove('opacity-50');
            document.getElementById('sim-status').innerText = "‚úÖ Scientific Simulation Complete.";

            // Update UI
            document.getElementById('eq-rate').innerText = res.win_rate + '%';
            document.getElementById('eq-wins').innerText = res.wins;
            document.getElementById('eq-losses').innerText = res.losses;
            document.getElementById('eq-pips').innerText = userFormat(res.net_pips);
            document.getElementById('eq-pips').className = `text-lg font-bold font-mono ${res.net_pips >= 0 ? 'text-blue-500' : 'text-red-500'}`;

            document.getElementById('eq-total').innerText = res.total_trades;
            document.getElementById('eq-dd').innerText = res.max_drawdown + '%';
            document.getElementById('eq-final').innerText = '$' + res.final_balance.toLocaleString();
            document.getElementById('eq-final').className = `text-xl font-bold font-mono ${res.final_balance >= parseFloat(localStorage.getItem('eq_balance')) ? 'text-green-500' : 'text-red-500'}`;

            // Chart
            const labels = res.equity_curve.map((p, i) => i === 0 ? 'Start' : `#${i}`);
            const data = res.equity_curve.map(p => p.y);
            renderChart(labels, data, true, document.documentElement.classList.contains('dark'));
        }

        function renderChart(labels, data, isProfit, isDark) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            if (equityChartInstance) equityChartInstance.destroy();

            const color = isProfit ? '#10b981' : '#ef4444';
            const gridColor = isDark ? '#232d3d' : '#e5e7eb';
            const tickColor = isDark ? '#9ca3af' : '#4b5563';

            equityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Equity',
                        data: data,
                        borderColor: color,
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, color + '20');
                            gradient.addColorStop(1, color + '00');
                            return gradient;
                        },
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: { label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', { minimumFractionDigits: 2 }) },
                            backgroundColor: isDark ? '#161d27' : '#ffffff',
                            titleColor: isDark ? '#fff' : '#000',
                            bodyColor: isDark ? '#ccc' : '#4b5563',
                            borderColor: isDark ? '#232d3d' : '#e5e7eb',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: {
                            grid: { color: gridColor },
                            ticks: { color: tickColor, callback: (val) => '$' + val.toLocaleString() },
                            border: { display: false }
                        }
                    }
                }
            });
        }

        function userFormat(num) {
            return (num > 0 ? '+' : '') + num.toFixed(1);
        }

        async function refreshSignal(msgId) {
            const btn = event.currentTarget;
            btn.classList.add('animate-spin');

            try {
                // Request Update via Database
                const { error } = await dbClient
                    .from('archived_messages')
                    .update({ refresh_needed: true })
                    .eq('msg_id', msgId);

                if (error) throw error;

                setTimeout(() => {
                    btn.classList.remove('animate-spin');
                    btn.innerHTML = "‚è≥ Sent";
                    btn.disabled = true;
                }, 1000);

            } catch (e) {
                alert("Error sending refresh request: " + e.message);
                btn.classList.remove('animate-spin');
            }
        }
    </script>
    <script>
        // Pull to Refresh (Targeting #feed container)
        // Re-added correctly outside main block
        let touchStart = 0;
        let touchPull = 0;
        const feed = document.getElementById('feed'); // This element exists in DOM
        // Visual indicator
        const refreshIndicator = document.createElement('div');
        refreshIndicator.className = "fixed top-0 left-0 w-full h-1 bg-blue-500 transform scale-x-0 transition-transform origin-left z-50";
        document.body.appendChild(refreshIndicator);

        if (feed) {
            feed.addEventListener('touchstart', e => {
                if (feed.scrollTop <= 0) touchStart = e.touches[0].clientY;
            }, { passive: true });

            feed.addEventListener('touchmove', e => {
                if (touchStart === 0) return;
                const touchY = e.touches[0].clientY;
                touchPull = touchY - touchStart;

                if (feed.scrollTop <= 0 && touchPull > 0) {
                    const percent = Math.min(touchPull / 200, 1);
                    refreshIndicator.style.transform = `scaleX(${percent})`;
                }
            }, { passive: true });

            feed.addEventListener('touchend', () => {
                if (feed.scrollTop <= 0 && touchPull > 150) {
                    refreshIndicator.style.transform = `scaleX(1)`;
                    setTimeout(() => location.reload(), 200);
                } else {
                    refreshIndicator.style.transform = `scaleX(0)`;
                }
                touchStart = 0;
                touchPull = 0;
            });
        }
    </script>
</body>

</html>
