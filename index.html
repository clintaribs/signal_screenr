<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRUTHWATCH | Supabase Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- PWA Setup -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b1118">
    <link rel="apple-touch-icon" href="logo.png">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed', err));
            });
        }
    </script>
    <style>
        .tag-SIGNAL {
            background: #4b5563;
        }

        .tag-EDITED {
            background: #ffa502;
            color: black;
        }

        .tag-DELETED {
            background: #ff4757;
        }

        .tag-TP_SIGNAL {
            background: #a55eea;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            /* gray-200 */
        }

        .dark ::-webkit-scrollbar-track {
            background: #161d27;
        }

        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            /* gray-400 */
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #232d3d;
        }
    </style>
</head>

<body
    class="bg-gray-100 dark:bg-[#0b1118] text-gray-900 dark:text-[#e0e6ed] fixed inset-0 h-full w-full flex flex-col overflow-hidden font-sans transition-colors duration-200">

    <!-- Mobile Header -->
    <header
        class="md:hidden bg-white dark:bg-[#161d27] border-b border-gray-200 dark:border-[#232d3d] p-4 flex justify-between items-center z-20 transition-colors duration-200">
        <div class="font-bold text-blue-600 dark:text-blue-400 flex items-center gap-2">
            TruthWatch
            <button onclick="location.reload()"
                class="ml-4 text-xl p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-800 transition">üîÑ</button>
            <button onclick="toggleTheme()"
                class="ml-2 text-xl p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-800 transition">üåì</button>
        </div>
        <button onclick="toggleMobileMenu()"
            class="text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                </path>
            </svg>
        </button>
    </header>

    <div class="flex flex-grow overflow-hidden relative">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed inset-y-0 left-0 md:relative w-80 h-full border-r border-gray-200 dark:border-[#232d3d] flex flex-col bg-white dark:bg-[#0f151e] transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 pt-0 md:pt-0 shadow-2xl md:shadow-none transition-colors duration-200">
            <div class="p-6 border-b border-gray-200 dark:border-[#232d3d] hidden md:block">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold tracking-wider text-blue-600 dark:text-blue-400">TruthWatch</h1>
                    <div class="flex items-center space-x-2">
                        <button onclick="location.reload()"
                            class="text-xl p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-800 transition"
                            title="Refresh App">üîÑ</button>
                        <button onclick="toggleTheme()"
                            class="text-xl p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-800 transition">üåì</button>
                    </div>
                </div>
                <div class="text-xs text-gray-500 mt-1">Powered by Supabase</div>
                <button onclick="openLeaderboard()"
                    class="w-full mt-6 bg-blue-600 hover:bg-blue-500 py-2 rounded font-bold transition">üèÜ
                    Leaderboard</button>
            </div>
            <div class="p-4 md:hidden flex justify-between items-center border-b border-[#232d3d]">
                <span class="font-bold">Channels</span>
                <button onclick="toggleMobileMenu()"
                    class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <!-- Mobile Leaderboard Button -->
            <div class="md:hidden p-4">
                <button onclick="openLeaderboard()"
                    class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded font-bold transition">üèÜ
                    Leaderboard</button>
            </div>

            <div id="channel-list" class="flex-grow overflow-y-auto p-2 space-y-1"></div>
        </aside>

        <!-- Overlay for mobile sidebar -->
        <div id="mobile-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden">
        </div>

        <!-- Main Content -->
        <main
            class="flex-grow flex flex-col relative w-full bg-gray-50 dark:bg-[#0b1118] transition-colors duration-200">
            <header
                class="p-4 bg-white dark:bg-[#161d27] border-b border-gray-200 dark:border-[#232d3d] flex justify-between items-center shadow-md z-10 transition-colors duration-200">
                <div>
                    <h2 id="active-title"
                        class="text-xl font-semibold truncate max-w-[200px] text-gray-900 dark:text-white">Select
                        Provider</h2>
                    <div id="active-score" class="text-sm text-gray-500"></div>
                </div>
                <div id="header-btns" class="hidden flex space-x-2">
                    <button onclick="openStats()"
                        class="bg-gray-100 hover:bg-gray-200 dark:bg-[#232d3d] dark:hover:bg-[#2f3b4f] px-3 py-2 rounded border border-gray-300 dark:border-[#3e4d5e] transition text-sm text-gray-700 dark:text-gray-300">üìä</button>
                    <button onclick="openPerf()"
                        class="bg-gray-100 hover:bg-gray-200 dark:bg-[#232d3d] dark:hover:bg-[#2f3b4f] px-3 py-2 rounded border border-gray-300 dark:border-[#3e4d5e] transition text-sm text-gray-700 dark:text-gray-300">üìà</button>
                </div>
            </header>

            <div id="feed" class="flex-grow p-4 md:p-6 overflow-y-auto flex flex-col space-y-4">
                <div class="text-center text-gray-600 mt-20">Select a channel to view auditable signals.</div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-bg"
        class="fixed inset-0 bg-black/50 dark:bg-black/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm"
        onclick="closeModal(event)">
        <div class="bg-white dark:bg-[#161d27] w-full max-w-3xl rounded-xl border border-gray-200 dark:border-blue-500/30 shadow-2xl flex flex-col max-h-[85vh] transition-colors duration-200"
            onclick="event.stopPropagation()">
            <div
                class="p-6 border-b border-gray-200 dark:border-[#232d3d] flex justify-between items-center bg-gray-50 dark:bg-[#1c2531] rounded-t-xl transition-colors duration-200">
                <h2 id="modal-title" class="text-xl md:text-2xl font-bold truncate text-gray-900 dark:text-white">
                    Details</h2>
                <button onclick="closeModal()"
                    class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-content" class="p-4 md:p-8 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://pbxxmbntchgmwencefdr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBieHhtYm50Y2hnbXdlbmNlZmRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTQ1NjAsImV4cCI6MjA4NDE3MDU2MH0.pD6IHRH9_XyA3f3YrrftjPZ4xLFlGc6WE6lLiF06r4Y";

        // Fix: createClient is inside the supabase global object from CDN
        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        let allData = [];
        let providerStats = {};
        let currentChannel = "";

        // Toggle Theme
        window.toggleTheme = () => {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Init Theme
        if (localStorage.getItem('theme') === 'light') {
            document.documentElement.classList.remove('dark');
        }

        // Mobile Toggle
        window.toggleMobileMenu = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // Fetch Initial Data
        async function init() {
            const { data: msgs } = await dbClient.from('archived_messages').select('*');
            if (msgs) allData = msgs;

            const { data: stats } = await dbClient.from('provider_stats').select('*');
            if (stats) stats.forEach(s => providerStats[s.channel_name] = s);

            renderChannels();

            // Realtime Subscription
            dbClient.channel('public:archived_messages')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'archived_messages' }, payload => {
                    if (payload.eventType === 'INSERT') {
                        allData.push(payload.new);
                    } else if (payload.eventType === 'UPDATE') {
                        const idx = allData.findIndex(d => d.msg_id === payload.new.msg_id);
                        if (idx > -1) allData[idx] = payload.new;
                    } else if (payload.eventType === 'DELETE') {
                        // Note: Payload.old only has ID usually
                        allData = allData.filter(d => d.msg_id !== payload.old.msg_id);
                    }

                    if (currentChannel) {
                        renderFeed();
                        // If Performance Modal is Open, Refresh it
                        const modalTitle = document.getElementById('modal-title');
                        const modalBg = document.getElementById('modal-bg');
                        if (!modalBg.classList.contains('hidden') && modalTitle.innerText === "Trade Performance") {
                            openPerf();
                        }
                    }
                    renderChannels();
                })
                .subscribe();

            dbClient.channel('public:provider_stats')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'provider_stats' }, payload => {
                    if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                        providerStats[payload.new.channel_name] = payload.new;
                    }
                    renderChannels();
                    if (currentChannel) updateHeaderStats();
                })
                .subscribe();
        }
        init();

        window.selectChannel = (name) => {
            currentChannel = name;
            // Mark as Read
            localStorage.setItem('lastRead_' + name, Date.now() / 1000);

            document.getElementById('active-title').innerText = name;
            document.getElementById('header-btns').classList.remove('hidden');
            updateHeaderStats();
            renderFeed();
            renderChannels();

            // Close mobile menu if open
            if (!document.getElementById('sidebar').classList.contains('-translate-x-full')) {
                toggleMobileMenu();
            }
        };

        function updateHeaderStats() {
            const stats = providerStats[currentChannel];
            const score = stats ? stats.score : 100;
            document.getElementById('active-score').innerHTML = `Truth Score: <span class="${score < 80 ? 'text-red-500' : 'text-green-400'} font-bold">${score}</span>`;
        }

        function renderChannels() {
            const list = document.getElementById('channel-list');
            list.innerHTML = '';

            // Collect all unique channel names from messages and stats
            const msgChannels = new Set(allData.map(d => d.channel_name));
            const statChannels = new Set(Object.keys(providerStats));
            const allChannelNames = [...new Set([...msgChannels, ...statChannels])];

            // Sort by Score (High to Low)
            const sortedChannels = allChannelNames
                .filter(ch => {
                    const s = providerStats[ch];
                    // STRICT filtering: 
                    // 1. Must exist in providerStats (implies it was discovered/synced)
                    // 2. active must be true
                    // Fallback: If no stats exist yet (rare race condition), we hide it to be safe, 
                    // or show it if it has recent messages? 
                    // BETTER: Trust the backend sync. If backend says active=false (or missing), hide it.
                    if (!s) return false;
                    return s.active === true;
                })
                .sort((a, b) => {
                    const scoreA = providerStats[a]?.score || 0;
                    const scoreB = providerStats[b]?.score || 0;
                    return scoreB - scoreA;
                });

            sortedChannels.forEach(channel => {
                const stats = providerStats[channel] || { score: 0 }; // Default score if no stats
                const isActive = channel === currentChannel;

                const div = document.createElement('div');
                div.className = `p-3 rounded mx-2 cursor-pointer flex justify-between items-center transition ${isActive ? 'bg-gray-200 dark:bg-[#232d3d] border-l-4 border-blue-500 text-blue-600 dark:text-blue-400' : 'hover:bg-gray-100 dark:hover:bg-[#1c2531] border-l-4 border-transparent text-gray-600 dark:text-gray-400'}`;
                div.onclick = () => {
                    selectChannel(channel);
                    if (window.innerWidth < 768) toggleMobileMenu(); // Auto-close on mobile
                };

                const lastRead = parseFloat(localStorage.getItem('lastRead_' + channel) || '0');
                const channelMsgs = allData.filter(m => m.channel_name === channel);
                const lastMsgTime = channelMsgs.length > 0 ? Math.max(...channelMsgs.map(m => m.timestamp)) : 0;
                const hasUnread = lastMsgTime > lastRead;

                div.innerHTML = `
                    <div class="flex items-center space-x-2 overflow-hidden">
                        ${hasUnread ? '<div class="w-2 h-2 rounded-full bg-red-500 flex-shrink-0 animate-pulse"></div>' : ''}
                        <span class="font-medium truncate max-w-[140px]">${channel}</span>
                    </div>
                    <span class="text-xs font-bold ${stats.score < 80 ? 'text-red-500' : 'text-green-500'} bg-black/5 dark:bg-black/30 px-2 py-1 rounded flex-shrink-0">${stats.score}</span>
                `;
                list.appendChild(div);
            });
        }

        function renderFeed() {
            const feed = document.getElementById('feed');
            const msgs = allData.filter(m => m.channel_name === currentChannel).sort((a, b) => a.timestamp - b.timestamp);

            if (msgs.length === 0) {
                feed.innerHTML = '<div class="text-center text-gray-500 mt-10">No messages found.</div>';
                return;
            }

            feed.innerHTML = msgs.map(m => {
                const time = new Date(m.timestamp * 1000).toLocaleString('en-GB', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });

                let tagsHtml = '';
                if (m.is_signal) tagsHtml += `<span class="tag-SIGNAL text-[10px] px-2 py-0.5 rounded font-bold mr-2">SIGNAL</span>`;
                if (m.status === 'EDITED') tagsHtml += `<span class="tag-EDITED text-[10px] px-2 py-0.5 rounded font-bold mr-2">EDITED</span>`;
                if (m.status === 'DELETED') tagsHtml += `<span class="tag-DELETED text-[10px] px-2 py-0.5 rounded font-bold mr-2 text-white">DELETED</span>`;
                if (m.tags && m.tags.includes('TP_SIGNAL')) tagsHtml += `<span class="tag-TP_SIGNAL text-[10px] px-2 py-0.5 rounded font-bold text-white mr-2">TP_SIGNAL</span>`;

                let details = '';
                if (m.is_signal && m.entry) {
                    details = `<div class="mt-2 text-xs text-blue-600 dark:text-blue-300 font-mono bg-gray-100 dark:bg-black/20 p-2 rounded inline-block w-full overflow-x-auto">
                    ${m.action} @ ${m.entry} | TP: ${m.tp || '--'} | SL: ${m.sl || '--'} | Mkt: ${m.market_at_time || '--'}
                </div>`;
                }

                return `<div class="bg-white dark:bg-[#161d27] p-4 rounded-lg border border-gray-200 dark:border-[#232d3d] self-start w-full max-w-3xl hover:border-blue-500/30 transition shadow-sm">
                <div class="text-[11px] text-gray-500 mb-2 flex flex-wrap items-center justify-between gap-2">
                    <div>${time}</div>
                    <div class="flex flex-wrap gap-1">${tagsHtml}</div>
                </div>
                <div class="whitespace-pre-wrap text-sm leading-relaxed break-words text-gray-700 dark:text-gray-300">${m.text || "[Content Deleted]"}</div>
                ${details}
            </div>`;
            }).join('') + '<div class="h-32 w-full flex-shrink-0"></div>'; // Add explicit spacer at bottom
            feed.scrollTop = feed.scrollHeight;
        }

        window.closeModal = (e) => {
            if (!e || e.target.id === 'modal-bg' || !e.target.closest('#modal-content')) {
                document.getElementById('modal-bg').classList.add('hidden');
            }
        };
        document.querySelector('button[onclick="closeModal()"]').onclick = () => document.getElementById('modal-bg').classList.add('hidden');

        window.openLeaderboard = () => {
            const sorted = Object.entries(providerStats)
                .filter(([, s]) => s.active !== false)
                .sort(([, a], [, b]) => b.score - a.score);

            document.getElementById('modal-title').innerText = "Global Leaderboard";
            document.getElementById('modal-content').innerHTML = `
            <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse min-w-[500px]">
                <thead>
                    <tr class="text-gray-500 border-b border-gray-200 dark:border-[#232d3d] text-xs uppercase tracking-wider">
                        <th class="p-3">Rank</th>
                        <th class="p-3">Provider</th>
                        <th class="p-3 text-center">Score</th>
                        <th class="p-3 text-center">Trades</th>
                        <th class="p-3 text-center">TP Sigs</th>
                        <th class="p-3 text-center">Net Pips</th>
                        <th class="p-3 text-center">Edits</th>
                        <th class="p-3 text-center">Del</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    ${sorted.map(([name, s], i) => `
                        <tr class="border-b border-gray-100 dark:border-[#232d3d] hover:bg-gray-50 dark:hover:bg-[#1c2531] transition-colors">
                            <td class="p-3 font-mono text-gray-400">#${i + 1}</td>
                            <td class="p-3 font-bold text-blue-600 dark:text-blue-400 whitespace-nowrap">${name}</td>
                            <td class="p-3 text-center font-bold ${s.score >= 80 ? 'text-green-500' : 'text-red-500'}">${s.score}</td>
                            <td class="p-3 text-center text-gray-700 dark:text-gray-300">${s.total || 0}</td>
                            <td class="p-3 text-center text-purple-500 font-bold">${s.tp_signals || 0}</td>
                            <td class="p-3 text-center font-bold ${s.net_profit >= 0 ? 'text-green-500' : 'text-red-500'}">${s.net_profit != null ? (s.net_profit > 0 ? '+' : '') + s.net_profit : '--'}</td>
                            <td class="p-3 text-center text-orange-400">${s.edits}</td>
                            <td class="p-3 text-center text-red-500">${s.deletes}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            </div>`;
            document.getElementById('modal-bg').classList.remove('hidden');
            if (!document.getElementById('sidebar').classList.contains('-translate-x-full')) {
                toggleMobileMenu();
            }
        };

        window.openStats = () => {
            const stats = providerStats[currentChannel] || { score: 100, edits: 0, deletes: 0, tp_signals: 0 };
            const sigs = allData.filter(m => m.channel_name === currentChannel && m.is_signal).length;

            document.getElementById('modal-title').innerText = `${currentChannel} Stats`;
            document.getElementById('modal-content').innerHTML = `
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">${sigs}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Signals</div>
                </div>
                <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold ${stats.score >= 80 ? 'text-green-500' : 'text-red-500'}">${stats.score}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Score</div>
                </div>
                 <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-yellow-500">${stats.win_rate != null ? stats.win_rate + '%' : 'N/A'}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Win Rate</div>
                </div>
                 <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-purple-500">${stats.tp_signals || 0}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">TP Signals</div>
                </div>
                 <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-orange-400">${stats.edits}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Edits</div>
                </div>
                <div class="bg-white dark:bg-[#0b1118] p-4 md:p-6 rounded-lg text-center border border-gray-200 dark:border-[#232d3d]">
                    <div class="text-2xl md:text-3xl font-bold text-red-500">${stats.deletes}</div>
                    <div class="text-gray-500 text-xs md:text-sm mt-1">Deletes</div>
                </div>
            </div>`;
            document.getElementById('modal-bg').classList.remove('hidden');
        };

        window.openPerf = () => {
            const sigs = allData.filter(m => m.channel_name === currentChannel && m.is_signal).sort((a, b) => a.timestamp - b.timestamp);

            document.getElementById('modal-title').innerText = "Trade Performance";
            document.getElementById('modal-content').innerHTML = `
            <div class="space-y-4">
                ${sigs.length === 0 ? '<div class="text-gray-500 text-center">No trades recorded.</div>' : ''}
                ${sigs.map(s => {
                const isWin = s.outcome === 'WIN';
                const isLoss = s.outcome === 'LOSS';
                const isBuy = s.action === 'BUY';
                const borderClass = isWin ? 'border-green-500' : isLoss ? 'border-red-500' : 'border-blue-500';
                const outcomeClass = isWin ? 'text-green-500' : isLoss ? 'text-red-500' : 'text-blue-500';
                const typeClass = isBuy ? 'text-green-600 dark:text-green-400 bg-green-500/10' : 'text-red-600 dark:text-red-400 bg-red-500/10';

                return `
                    <div class="bg-white dark:bg-[#0b1118] p-4 rounded border-l-4 ${borderClass} flex flex-col md:flex-row justify-between items-start md:items-center shadow-lg transition-colors border max-w-full">
                        <div class="mb-2 md:mb-0 w-full">
                            <div class="flex items-center justify-between mb-2">
                                <span class="px-3 py-1 rounded font-bold text-xs md:text-xs uppercase ${typeClass} tracking-wide border border-current">${s.action} ${s.asset || 'GOLD'}</span>
                                <span class="text-xs text-gray-500">${new Date(s.timestamp * 1000).toLocaleString('en-GB')}</span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm md:text-xs font-mono text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-[#161d27] p-2 rounded">
                                <div><span class="text-gray-500 dark:text-gray-600 block text-[10px] uppercase">Entry</span>${s.entry}</div>
                                <div><span class="text-gray-500 dark:text-gray-600 block text-[10px] uppercase">TP</span>${s.tp || '--'}</div>
                                <div><span class="text-gray-500 dark:text-gray-600 block text-[10px] uppercase">SL</span>${s.sl || '--'}</div>
                                <div><span class="text-gray-500 dark:text-gray-600 block text-[10px] uppercase">Mkt Price</span>${s.market_at_time || '--'}</div>
                            </div>
                        </div>
                        <div class="text-right md:ml-6 min-w-[100px] mt-3 md:mt-0 border-t md:border-t-0 border-[#232d3d] pt-3 md:pt-0 flex flex-col items-end">
                             <div class="text-xl md:text-2xl font-bold ${outcomeClass}">${s.outcome}</div>
                            <div class="text-xs text-gray-500">Run: <span class="${s.max_run_pips > 0 ? 'text-green-400' : 'text-gray-400'}">${s.max_run_pips} pips</span></div>
                            ${s.outcome === 'LIVE' ? `
                            <button onclick="refreshSignal(${s.msg_id})" class="mt-2 text-xs bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 px-2 py-1 rounded border border-blue-600/50 transition flex items-center gap-1" title="Ping MT5 Update">
                                üîÑ Update
                            </button>` : ''}
                        </div>
                    </div>`;
            }).join('')}
            </div>`;
            document.getElementById('modal-bg').classList.remove('hidden');
        };

        async function refreshSignal(msgId) {
            const btn = event.currentTarget;
            btn.classList.add('animate-spin');

            try {
                // Request Update via Database
                const { error } = await dbClient
                    .from('archived_messages')
                    .update({ refresh_needed: true })
                    .eq('msg_id', msgId);

                if (error) throw error;

                setTimeout(() => {
                    btn.classList.remove('animate-spin');
                    btn.innerHTML = "‚è≥ Sent";
                    btn.disabled = true;
                }, 1000);

            } catch (e) {
                alert("Error sending refresh request: " + e.message);
                btn.classList.remove('animate-spin');
            }
        }
    </script>
    <script>
        // Pull to Refresh (Targeting #feed container)
        // Re-added correctly outside main block
        let touchStart = 0;
        let touchPull = 0;
        const feed = document.getElementById('feed'); // This element exists in DOM
        // Visual indicator
        const refreshIndicator = document.createElement('div');
        refreshIndicator.className = "fixed top-0 left-0 w-full h-1 bg-blue-500 transform scale-x-0 transition-transform origin-left z-50";
        document.body.appendChild(refreshIndicator);

        if (feed) {
            feed.addEventListener('touchstart', e => {
                if (feed.scrollTop <= 0) touchStart = e.touches[0].clientY;
            }, { passive: true });

            feed.addEventListener('touchmove', e => {
                if (touchStart === 0) return;
                const touchY = e.touches[0].clientY;
                touchPull = touchY - touchStart;

                if (feed.scrollTop <= 0 && touchPull > 0) {
                    const percent = Math.min(touchPull / 200, 1);
                    refreshIndicator.style.transform = `scaleX(${percent})`;
                }
            }, { passive: true });

            feed.addEventListener('touchend', () => {
                if (feed.scrollTop <= 0 && touchPull > 150) {
                    refreshIndicator.style.transform = `scaleX(1)`;
                    setTimeout(() => location.reload(), 200);
                } else {
                    refreshIndicator.style.transform = `scaleX(0)`;
                }
                touchStart = 0;
                touchPull = 0;
            });
        }
    </script>
</body>

</html>